<!DOCTYPE html>
<html>

<head>
	<meta charset="utf-8">
	<meta name="viewport" content="width=device-width,initial-scale=1,minimum-scale=1,maximum-scale=1,user-scalable=0">
	<title>缺课记录</title>
	<!-- <link rel="stylesheet" type="text/css" href="../../css/common.css" />
	<link rel="stylesheet" type="text/css" href="../../css/swiper-3.4.2.min.css" />
	<link rel="stylesheet" type="text/css" href="../../iconfont/iconfont.css" />
	<link rel="stylesheet" type="text/css" href="../../css/commonUI.css" />
	<link rel="stylesheet" type="text/css" href="../../css/animate.css" />
	<link rel="stylesheet" type="text/css" href="../../css/index.css" />
	<link rel="stylesheet" type="text/css" href="../../css/simplePagination.css" />
	<link rel="stylesheet" type="text/css" href="../../css/index1.css" />
	<link rel="stylesheet" type="text/css" href="../../css/webuploader/webuploader.css" />
	<script src="../../js/resize.js" type="text/javascript" charset="utf-8"></script> -->

	<!-- <link rel="stylesheet" href="mobile/css/weui.min.css"> -->
	<link rel="stylesheet" href="../../css/weui.min.css">
    <!-- <link rel="stylesheet" href="mobile/css/jquery-weui.min.css"> -->
    <link rel="stylesheet" href="../../css/jquery-weui.min.css">
    <!-- <script src="http://www.jq22.com/jquery/jquery-1.10.2.js"></script> -->
    <script src="http://www.jq22.com/jquery/jquery-1.10.2.js"></script>
    <!-- <script type="text/javascript" src="mobile/js/jquery-weui.min.js"></script> -->
    <script type="text/javascript" src="../../js/jquery-weui.min.js"></script>
    <!-- <script type="text/javascript" src="mobile/jquery-3.3.1.min.js"></script> -->
    <script type="text/javascript" src="../../js/jquery-3.3.1.min.js"></script>
	<style type="text/css">
		body {
			background-color: #fff;
		}

		.my_course header,
		.my_children header,
		.ditui header {
			margin-top: 0.2rem;
			margin-bottom: 0.15rem;
			font-size: 0.28rem;
			font-weight: 900;
		}

		.ditui li {
			height: 0.9rem;
			line-height: 0.9rem;
			border-bottom: 1px solid #eee;
		}

		.ditui li i {
			float: right;
			font-size: 0.3rem;
		}

		.my_course i {
			float: right;
			font-weight: 100;
		}

		.my_course img {
			width: 4rem;
			display: block;
			margin: auto;
		}

		.my_course li {
			margin-top: 0.2rem;
		}

		.my_children {
			/* margin-bottom: 0.5rem; */
		}

		.my_children ul ul {
			clear: both;
			position: relative;
			/*right: 0.5rem;*/
			width: 7.5rem;
			border-bottom: 1px solid #eee;
			padding: 0 0.2rem;
		}

		.my_children ul ul li {
			text-align: center;
			float: left;
			width: 33.33%;
			padding-bottom: 0.15rem;
			padding-top: 0.2rem;

		}

		.my_children img {
			width: 0.61rem;
			height: 0.61rem;
			border-radius: 0.61rem;

		}

		.my_children button {
			margin-bottom: 0.15rem;
			width: 1.6rem;
			height: 0.55rem;
			border-radius: 0.55rem;
			background-color: #FBD15B;
			border: 0;
		}

		.pre img {
			width: 0.4rem;
			position: absolute;
			top: 0.45rem;
			left: 0.2rem;
			z-index: 222;
		}

		.pre,
		.swiper-container .next {
			display: none;
		}

		.swiper-container .next img {
			z-index: 222;
			width: 0.4rem;
			position: absolute;
			top: 0.45rem;
			right: 0.2rem !important;
		}

		.hadregister {
			background-color: #FDE8AD !important;
		}

		.noregister {
			background-color: #EAEAEA !important;
		}

		.t_card .more {
			display: block;
			position: absolute;
			width: 0.55rem;
			right: 0.2rem;
			bottom: 0.2rem;
		}

		.teacher .tab {
			padding: 0 1.2rem;
		}

		.teacher .tab li {
			width: 33.33%;
		}

		.circle_out {
			width: 5.5rem;
			height: 4.5rem;
			margin: auto;
			border-left: 0.277rem solid #809292;
			border-bottom: 0.277rem solid #809292;
			position: relative;
		}

		.circle1 {
			position: absolute;
			height: 80%;
			width: 1.34rem;
			background-color: red;
			left: 0.47rem;
			bottom: 0;
		}

		.circle2 {
			position: absolute;
			height: 60%;
			width: 1.34rem;
			background-color: #EFB511;
			left: 2.8rem;
			bottom: 0;
		}

		.t {
			position: absolute;
			top: -0.4rem;
			width: 100%;
			text-align: center;
			color: red;
		}

		.b {
			width: 1.9rem;
			left: -0.2rem;
			position: absolute;
			bottom: -0.8rem;
		}

		.content {
			padding-left: 1.5rem;
			margin-top: 0.2rem;
		}

		.queke {
			margin-top: 0.2rem;
			margin-bottom: 0 !important;
		}

		.teacher .main {
			padding: 0;
		}

		/* daibuke */
		.headportrait {
			width: 0.61rem;
			height: 0.61rem;
			border-radius: 0.61rem;
			float: left;
		}

		.warp-box {
			padding-bottom: 0;
			width: 66.66%;
			text-align: left;
			float: left;
		}

		.bootom {
			margin-bottom: 0.15rem;
			width: 1.6rem;
			height: 0.55rem;
			border-radius: 0.55rem;
			background-color: #FBD15B;
			border: 0;
			float: left;
		}
		.min_head img{
    width: 2.2em;
    height: 2.2em;
  }
  .min_head{
    margin-right: .2em;
    border-radius: 3em;
  }
  .two_list li a.weui-cell{
    padding: 0;
    width: 100%;
  }
  .sign{
    border: 1px solid #D60711;
    border-radius: 4px;
    color: #D60711;
    /*border: 1px solid #d31e1e;*/
  }
  .sign a{
    color: #D60711;
  }
  .searchhead{
    position: fixed;
    top: 0;
    width: 100%;
    z-index: 2;
  }
  .active{
    background-color: #D60711;
  }
  .active a,.active .weui-cell__ft{
    color: #fff;
  }
		/* .min_head {
		    width: 0.61rem;
    height: 0.61rem;
    border-radius: 0.61rem;
		} */
		.but-an{
			border: none;
    /* background: #ff0; */
    border-radius: 0.55rem;
    background-color: #FBD15B;
    padding: 0.4rem 1.2rem;
		}
		.weui-cell__bd{
			color: #000;
		}
	</style>
</head>

<body class="up-page quekele">
	<div class="searchhead">
		<div class="weui-search-bar" id="searchBar">
		  <form class="weui-search-bar__form" onsubmit="return search();">
			<div class="weui-search-bar__box">
			  <i class="weui-icon-search"></i>
			  <input type="search" class="weui-search-bar__input" id="searchInput" placeholder="输入姓名搜索" required="">
			  <a href="javascript:" class="weui-icon-clear" id="searchClear"></a>
			</div>
			<label class="weui-search-bar__label" id="searchText">
			  <i class="weui-icon-search"></i>
			  <span>请输入学员姓名</span>
			</label>
		  </form>
		  <a href="javascript:" class="weui-search-bar__cancel-btn" id="searchCancel">取消</a>
		</div>
	  </div>
	  <p style="height: 24px;"></p>
	  <div id="all_list">
		<ul class="weui-cells two_list  main_t">
		  </ul>
		 <h1 class="zwsj" style="color: #ccc; text-align: center;">暂无数据</h1>
	  </div>
	
</body>
<script src="../../js/jquery-1.7.2.js" type="text/javascript" charset="utf-8"></script>
<script src="../../js/jquery.simplePagination.js" type="text/javascript" charset="utf-8"></script>
<script src="../../js/swiper-3.4.2.min.js" type="text/javascript" charset="utf-8"></script>
<script src="../../js/commonUI.js" type="text/javascript" charset="utf-8"></script>
<script src="../../js/utils.js" type="text/javascript" charset="utf-8"></script>
<script src="../../css/webuploader/webuploader.js" type="text/javascript" charset="utf-8"></script>
<script type="text/javascript">
	// daibuke
	
	console.log(localStorage.getItem('zhizhao_uid'))
	var teacher=localStorage.getItem('zhizhao_uid')
	$.ajax({
		url: "http://139.224.133.133:8012/api/tch/v1/getmakeulist",
		data: {
			user_id:teacher,
			state:0,
			// student_name:name,
			orderby:0,
			pageindex:1,
			pagesize:10,
		},
		dataType: 'json',
		type: "get",
		success: function (res) {
			console.log(res.Data)
			var html = ''
			for (var i = 0; i < res.Data.list.length; i++) {
			
				html += `<li data-real_name="${res.Data.list[i].name}" class="weui-cell weui-cell_access list_one">
          <a class="weui-cell" href="#">
            <div class="weui-cell__hd min_head" >
              <img src="../../img/default_person.png" class="min_head"  alt=""/>
            </div>
            <div class="weui-cell__bd">
              <p>${res.Data.list[i].name}</p>
              <p>${res.Data.list[i].phone}</p>
            </div>
            <div class="weui-cell__ft"><button  onclick="goUrl('../../pingfen.html')" id="butt" class="but-an" data-id=${res.Data.list[i].id}  data-te=${res.Data.list[i].studentid}  data-n=${res.Data.list[i].name} class="register" id="1524"  index="64565">待补课</button></div>
          </a>
		</li>`

		if(!res.Data.list.length){
            $('.zwsj').css({display:"block"})

           }else{
			$('.zwsj').css({display:"none"})
		   }
			}

			$(html).appendTo($('.main_t'));
			
           $('.but-an').each(function(index,value){
			//    console.log(index,value)
			  $(this).click(function(){
				console.log($(this).attr('data-id'))
				console.log($(this).attr('data-te'))
				console.log($(this).attr('data-n'))
				// console.log(res.Data.list[i].name)
				console.log(localStorage.getItem('zhizhao_uid'))
				var teacher=localStorage.getItem('zhizhao_uid')
				// var name=$(this).attr('data-name')
			    // showTime();
				localStorage.setItem("id",$(this).attr('data-id'));
				localStorage.setItem("te",$(this).attr('data-te'));
				localStorage.setItem("na",$(this).attr('data-n'));
			   })
		   })
		},

	 
	});
  // 定义首个查询下键
  var active = 0;
  $('.weui-icon-search').click(function(){
    search();
  })
  function search(){
    // 获取搜索框的值
    var kwds = $("#searchInput").val();
    // 获取第一个列表内容
    var this_one = {};
    var real_name = '';
    // 定义两个数据列表
    var list = $("#all_list .list_one");
    // 定义查找的起始值
    var true_one = 0;
    for (var i = 0; i < list.length; i++) {
      this_one = $(list[i]);
      real_name = this_one.data('real_name').toString();
      // 执行like匹配
      if(real_name.match(kwds)){
        // 处理第一个结果
        if(true_one == active){
          // 获取窗口的宽和高
          // var windows_wdh = $(window).width();
          var windows_hgt = $(window).height();
          // 获取第一个坐标
          // var x_len = this_one.offset().left;
          var y_len = this_one.offset().top;
          // 驱动滚动条滚动到指定的位置
          $("html,body").animate({scrollTop:(y_len-windows_hgt/2)},500);
          // 标记当前选中的结果
          this_one.addClass('active');
          this_one.removeClass('sign');
        }else{
          // 标记符合的结果
          this_one.addClass('sign');
          this_one.removeClass('active');
        }
        // 累加真实的选择
        true_one++;
      }else{
        this_one.removeClass('sign');
        this_one.removeClass('active');
      }
    }
    // 判断是否搜索完毕 如果搜索完毕 则从第一个开始 否则继续搜索下一个
    active = active >= true_one-1 ? 0 : active+1;

    return false;
  }
//   1111111111111111111111111111111111111111111111111111111111111111111111111111111111111

	// var register=document.getElementsByClassName('register')
	// for(var i=0; i<register.length;i++){
	// 	register[i].onclick=function(){
	// 		console.log(1111)
	// 	}
	// 		// $('.register').click(function(){
	// 		// 	console.log(11111)
	// 		// })
	// 	}
	
	// 
	$('.search img').click(function () {
		pageindex = 1;
		showTime();
	})
	$('#search').bind('keyup', function (event) {

		if (event.keyCode == "13") {
			pageindex = 1;
			//回车执行查询
			showTime();
		}

	});
	//	AJAX
	var curriculumid, studentId, classImgLists = ""; //课程ID/学生id
	//、、、、、、、、、、、、、、、、、、、、、、、、、、、、、、、、、、、、、、、、、、、、、、
	var mySwiper = new Swiper('.swiper-container', {
		autoplay: 5000, //可选选项，自动滑动
		slidesPerView: 3,
		spaceBetween: 10
	})
	var BASE_URL = window.location.pathname;
	var uploader;
	uploaderInit();

	function uploaderInit() {


		uploader = WebUploader.create({

			// 选完文件后，是否自动上传。
			auto: true,

			// swf文件路径
			swf: BASE_URL + '/css/webuploader/Uploader.swf',

			// 文件接收服务端。
			server: hostAjax + '/api/other/v1/PostFile',

			// 选择文件的按钮。可选。
			// 内部根据当前运行是创建，可能是input元素，也可能是flash.
			pick: {
				id: '#modelImg',
				multiple: true
			},

			// 只允许选择图片文件。
			accept: {
				title: 'Images',
				extensions: '*',
				mimeTypes: 'image/*'
			}
		});
		/* 上传前判断 */
		uploader.on('beforeFileQueued', function (file) {

			progress = 0;
			/* 图片 */
			if ('gif,jpg,jpeg,bmp,png'.indexOf(file.ext.toLowerCase()) == -1) {
				alert('请上传图片文件');
				return false;
			} else {
				/* makeThumb方法生成缩略图获取图片base64 */
				uploader.makeThumb(file, function (error, src) {
					if (error) {
						alert('图片错误');
						return;
					}
					//        this.$refs.cropImg.changeImg(src, this.width, this.height, this.dataId);
				}, 1, 1); /* 缩略图尺寸，大于1为px，0-1之间为百分比 */
			}
			/* 视频 */
			if (this.type == 'video') {
				if ('mp4,webm,m3u8,ogg'.indexOf(file.ext.toLowerCase()) == -1) {
					alert('请上传支持的视频文件');
					return false;
				}
			}
			if (file.size > (3 * 1e8)) {
				alert('文件大小不可超过300M');
				return false;
			}
			/* 裁剪 */
			//    if (this.crop) {
			//      /* makeThumb方法生成缩略图获取图片base64 */
			//      this.uploader.makeThumb(file, (error, src) => {
			//        if (error) {
			//          this.$message('图片错误');
			//          return;
			//        }
			//        this.$refs.cropImg.changeImg(src, this.width, this.height, this.dataId);
			//      }, 1, 1); /* 缩略图尺寸，大于1为px，0-1之间为百分比 */
			//      return false;
			//    }
			//    this.loading = true;

			return true;

		})
		// 当有文件添加进来的时候
		uploader.on('uploadSuccess', function (file, response) {
			if (classImgLists.split("|").length > 9) { //超过之后的判断
				uploader.stop();
				ui.showToast("限制9张,已满！");
				return false;
			}
			try {
				classImgLists += response.Data[0].f_url + "|";
			} catch (e) {
				//TODO handle the exception
			}

			if (classImgLists.split("|").length > 3) {
				$(".pre").show();
				$(".next").show();
			}
			if (classImgLists.split("|").length > 9) {
				$('#modelImg').hide();
			}
			var $li;
			try {
				$li = $(
						'<div class="swiper-slide file-item thumbnail"  ontouchstart="gtouchstart(this)" ontouchmove="gtouchmove(this)" ontouchend="gtouchend(this)" style="background-image: url(' +
						response.Data[0].f_url + ');">' +
						//              '<img  src="'+response.Data[0].f_url+'"/>' +
						'</div>'
					),
					$img = $li.find('img');
			} catch (e) {
				//TODO handle the exception
			}

			// $list为容器jQuery实例
			$('.swiper-wrapper').append($li);
			mySwiper.update();
		});
		// 文件上传过程中创建进度条实时显示。
		uploader.on('uploadProgress', function (file, percentage) {

			var $li = $('#' + file.id),
				$percent = $li.find('.progress span');
			// 避免重复创建
			if (!$percent.length) {
				$percent = $('<p class="progress"><span></span></p>')
					.appendTo($li)
					.find('span');
			}

			$percent.css('width', percentage * 100 + '%');
			progress = parseInt(percentage * 100);
		});

	}
	//////////////////////////////////////////////------------------------------------
	var timeOutEvent = 0; //定时器   
	//开始按   
	function gtouchstart(_this) {
		timeOutEvent = setTimeout(function () {
			longPress(_this);
		}, 1000); //这里设置定时器，定义长按500毫秒触发长按事件，时间可以自己改，个人感觉500毫秒非常合适
		return false;
	};
	//手释放，如果在500毫秒内就释放，则取消长按事件，此时可以执行onclick应该执行的事件   
	function gtouchend(_this) {
		clearTimeout(timeOutEvent); //清除定时器   
		if (timeOutEvent != 0) {
			//这里写要执行的内容（尤如onclick事件）   
		}
		return false;
	};
	//如果手指有移动，则取消所有事件，此时说明用户只是要移动而不是长按   
	function gtouchmove(_this) {
		clearTimeout(timeOutEvent); //清除定时器   
		timeOutEvent = 0;

	};

	//真正长按后应该执行的内容   
	var splitStr = "",
		re, result, pageindex = 1;

	function longPress(_this) {
		timeOutEvent = 0;
		splitStr = $(_this).css("background-image").split('url("')[1].split('")')[0];
		splitStr += "\\|";

		console.log(splitStr)
		//执行长按要执行的内容，如弹出菜单   
		ui.showAlert('是否确认删除该图片', function () { //确认
			$(_this).remove();
			re = new RegExp(splitStr);
			classImgLists = classImgLists.replace(re, "");
		}, function () { //不是默认地址

			return false;
		}, "确定", "取消", "提示");
	}

	function clearFloat() {
		$('.float').hide();
		$('.class_show').hide();
		classImgLists = "";
		$("textarea").val(" ");
		$(".swiper-wrapper").html('<div class="swiper-slide" id="modelImg"><img src="../../img/addImg.png"/></div>');
		mySwiper.update();
		uploaderInit();
	}
	showTime();
	function showTime() {
		getAjax(hostAjax+"http://139.224.133.133:8012/api/tch/v1/getmakeulist", {
			user_id: location.href.indexOf("?uid=") > 0 ? location.href.split("?uid=")[1].split("&")[0] : uid,
			pageindex: pageindex,
			pagesize: 10,
			student_name: $("#search").val()
		}, function (data) {
			if (data.Data) {
				if (pageindex == 1 && data.Data.record / 10 > 1) {
					$('#light-pagination').pagination({ //分页
						pages: Math.ceil(data.Data.record / 10),
						cssStyle: 'light-theme',
					});
				}

				var str = "",
					registerStr = "",
					registerClass = "",
					jilustr = "",
					quekelustr = "",
					quekelustr1 = "";
				try {

					for (var i = 0; i < data.Data.list.length; i++) {
						if (data.Data.list[i].makeuplessons == 0) { //未补课
							registerStr = '<button class="register" id="' + data.Data.list[i].studentid +
								'" index="' + data.Data.list[i].curriculumid + '">补课</button>';
						} else {
							registerStr = '<button style="background-color:#eee;" >已补课</button>';
						}

						str += `<div class="my_children ">
					  <ul>
						<li>
							<ul class="ul" id=""><li style="width: 10%;"><img index="3890" src="../../img/default_person.png" alt=""><p></p></li>
								<li style="padding-bottom:0;width: 66.66%;text-align: left;">周2<p>2019/6/9 13:00:00-14:00:00</p></li>
								<li style="width: 23.33%;"><button class="register" id="1524" index="64565">补课</button></li>
								
							</ul>
						</li>
						</ul>
					
				        </div>`
					}

				} catch (e) {
					$(".my_children").hide();
					//TODO handle the exception
				}
				$(".my_children ul").html(str);
				$(".my_children img").click(function () {
					location.href = "../ditui/studentDetail.html?studentId=" + $(this).attr("index");
					console.log(1111)
				})
			} else {
				ui.showToast('没有缺课的小朋友', 13000);
			}
			$(".register").click(function () { //点击补课按钮
				studentId = $(this).attr('id');
				curriculumid = $(this).attr('index');
				$('.float').show();
				$("textarea").val(" ");
				$('.class_show').css("left", "0.6rem");
				$('.class_show').show();
			})
		})
	}
	$(".submit").click(function () { //
		if ($('textarea').val().trim().length <= 8) {
			ui.showToast('课堂表现的评语不能少于八个字~', 2000);
			return false;
		}
		ui.showAlert("请确认该学员已补课，提交后将扣除该学员对应课时", function () {
			getAjax(hostAjax + "/api/tch/v1/addabsencerecords", { //添加学生的课堂表现
				user_id: studentId,
				curriculumid: curriculumid,
				teacherid: location.href.indexOf("?uid=") > 0 ? location.href.split("?uid=")[1]
					.split("&")[0] : uid,
				principalsevaluation: $('textarea').val(),
				imglist: classImgLists.substring(0, classImgLists.length - 1)
			}, function (data) {
				if (data.Code == 200) {
					ui.showToast('提交成功');
					showTime();
					clearFloat();
					$("#" + studentId).find(".register").text("已表扬");
				} else {
					ui.showToast(data.Msg);
				}
			})
		}, null, "是的", "取消", "提示");
	})
	$(".next").click(function () {
		mySwiper.slideNext();
	})
	$(".pre").click(function () {
		mySwiper.slidePrev();
	})

	$('.float').click(function () {


		clearFloat();


	})
</script>

</html>